{% load static %}
{% load tailwind_tags %}
{% load bootstrap_icons %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book a Demo Class</title>
    {% tailwind_css %}
    <style>
        .date-hover:hover {
            background-color: #e0e7ff;
            cursor: pointer;
        }

        .date-selected {
            background-color: #3b82f6 !important;
            color: white;
        }

        .time-slot {
            transition: all 0.3s;
        }

        .time-slot:hover {
            transform: translateY(-2px);
        }

        .time-selected {
            background-color: #2563eb !important;
            color: white;
        }
    </style>
</head>

<body class="bg-gradient-to-t from-blue-50 to-white h-[100vh]">

    {% include 'skills/navbar.html' %}

    <div class="container mx-auto px-4 py-8">
        <div class="text-center mt-6 mb-20">
            <h1 class="text-3xl font-bold text-blue-900">Book a Demo Class</h1>
            <p class="text-blue-700 mt-2">Try our interactive learning experience with a free demo class</p>
        </div>

        <div class="flex flex-col md:flex-row gap-6 justify-center">
            <!-- Left Column - Calendar -->
            <div class="bg-white rounded-lg p-6 w-full md:w-1/2 lg:w-2/5"
                style="box-shadow: rgba(0, 0, 0, 0.1) 0px 4px 12px;">
                <div class="mb-6">
                    <div class="flex items-center">
                        {% bs_icon 'calendar' size='20px' extra_classes="text-gray-800" %}
                        <h2 class="text-lg font-semibold text-gray-800 ml-2">Select Date</h2>
                    </div>
                    <div class="mt-1">
                        <p class="text-sm text-gray-600">Choose your preferred date for the demo class</p>
                    </div>
                </div>

                <div class="calendar-container">
                    <div class="flex justify-between items-center mb-6">
                        <button id="prevMonth"
                            class="border rounded-full p-3 w-10 h-10 flex items-center justify-center text-white hover:bg-gray-100">
                            {% bs_icon 'chevron-left' size='20px' extra_classes="text-gray-400" %}
                        </button>

                        <h3 id="currentMonth" class="text-md font-medium">March 2025</h3>

                        <button id="nextMonth"
                            class="border rounded-full p-3 w-10 h-10 flex items-center justify-center text-white hover:bg-gray-100">
                            {% bs_icon 'chevron-right' size='20px' extra_classes="text-gray-400" %}
                        </button>
                    </div>

                    <div class="grid grid-cols-7 gap-1 text-center" id="calendarGrid">
                        <div class="text-sm font-medium text-gray-500">Su</div>
                        <div class="text-sm font-medium text-gray-500">Mo</div>
                        <div class="text-sm font-medium text-gray-500">Tu</div>
                        <div class="text-sm font-medium text-gray-500">We</div>
                        <div class="text-sm font-medium text-gray-500">Th</div>
                        <div class="text-sm font-medium text-gray-500">Fr</div>
                        <div class="text-sm font-medium text-gray-500">Sa</div>
                        <!-- Calendar days will be generated by JS -->
                    </div>
                </div>
            </div>

            <!-- Right Column - Time Slots and Form -->
            <div class="bg-white rounded-lg p-6 w-full md:w-1/2 lg:w-2/5"
                style="box-shadow: rgba(0, 0, 0, 0.1) 0px 4px 12px;">
                <div id="timeSlotContainer">
                    <div class="mb-6">
                        <div class="flex items-center">
                            {% bs_icon 'clock-history' size='20px' extra_classes="text-gray-800" %}
                            <h2 class="text-lg font-semibold text-gray-800 ml-2">Available Time Slots</h2>
                        </div>
                        <div class="mt-1">
                            <p class="text-sm text-gray-600">Pick a convenient time for your demo</p>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="timezone" class="block text-sm font-medium text-gray-700 mb-1">Select Time
                            Zone</label>
                        <select id="timezone"
                            class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="" disabled selected>Select your timezone</option>
                        </select>
                    </div>


                    <div id="timeSlotsGrid" class="grid grid-cols-2 gap-3 mb-4">
                        <!-- Time slots will be populated dynamically -->
                        <div class="text-center text-gray-500 col-span-2 py-4">Select a date to view available slots
                        </div>
                    </div>

                    <button id="showDetailsBtn"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-md text-sm font-medium transition-colors">Fill
                        Details</button>
                </div>

                <div id="detailsFormContainer" class="hidden">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Fill Your Details</h2>
                    <form id="bookingForm" method="post" action="{% url 'book_slot' %}">
                        {% csrf_token %}
                        <div class="space-y-4">
                            <div>
                                <label for="parent_name" class="block text-sm font-medium text-gray-700 mb-1">Parent
                                    Name</label>
                                <input type="text" id="parent_name" name="parent_name"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    required>
                            </div>

                            <div>
                                <label for="phone_number" class="block text-sm font-medium text-gray-700 mb-1">Phone
                                    Number</label>
                                <input type="tel" id="phone_number" name="phone_number"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    required>
                            </div>

                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="email" name="email"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    required>
                            </div>

                            <div>
                                <label for="student_name" class="block text-sm font-medium text-gray-700 mb-1">Student
                                    Name</label>
                                <input type="text" id="student_name" name="student_name"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    required>
                            </div>

                            <div>
                                <label for="grade" class="block text-sm font-medium text-gray-700 mb-1">Grade</label>
                                <select id="grade" name="grade"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    required>
                                    <option value="">Select Grade</option>
                                    <option value="1">Grade 1</option>
                                    <option value="2">Grade 2</option>
                                    <option value="3">Grade 3</option>
                                    <option value="4">Grade 4</option>
                                    <option value="5">Grade 5</option>
                                    <option value="6">Grade 6</option>
                                    <option value="7">Grade 7</option>
                                    <option value="8">Grade 8</option>
                                    <option value="9">Grade 9</option>
                                    <option value="10">Grade 10</option>
                                    <option value="11">Grade 11</option>
                                    <option value="12">Grade 12</option>
                                </select>
                            </div>

                            <!-- Hidden fields for date, time and timezone -->
                            <input type="hidden" id="booking_date" name="booking_date">
                            <input type="hidden" id="booking_time" name="booking_time">
                            <input type="hidden" id="booking_timezone" name="timezone">

                            <button type="submit"
                                class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-md text-sm font-medium transition-colors">Book
                                Demo Class</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Store selected date and time
            let selectedDate = null;
            let selectedTimeString = null;

            // Get elements
            const calendarGrid = document.getElementById('calendarGrid');
            const timeSlotsGrid = document.getElementById('timeSlotsGrid');
            const currentMonthElement = document.getElementById('currentMonth');
            const prevMonthButton = document.getElementById('prevMonth');
            const nextMonthButton = document.getElementById('nextMonth');
            const showDetailsBtn = document.getElementById('showDetailsBtn');
            const timezoneSelect = document.getElementById('timezone');
            const bookingForm = document.getElementById('bookingForm');

            // Get current date
            let currentDate = new Date();

            // Initialize calendar
            updateCalendar(currentDate);

            // Previous month button
            prevMonthButton.addEventListener('click', function () {
                currentDate.setMonth(currentDate.getMonth() - 1);
                updateCalendar(currentDate);
            });

            // Next month button
            nextMonthButton.addEventListener('click', function () {
                currentDate.setMonth(currentDate.getMonth() + 1);
                updateCalendar(currentDate);
            });

            // Timezone change event
            timezoneSelect.addEventListener('change', function () {
                if (selectedDate) {
                    fetchAvailableTimeSlots(selectedDate);
                }
            });

            function updateCalendar(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

                // Update header
                currentMonthElement.textContent = `${monthNames[month]} ${year}`;

                // Generate calendar days
                generateCalendarDays(year, month);
            }

            function generateCalendarDays(year, month) {
                // Clear existing dates (keep day headers)
                while (calendarGrid.children.length > 7) {
                    calendarGrid.removeChild(calendarGrid.lastChild);
                }

                // Get first day of month and number of days
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();

                // Get day of week for first day (0 = Sunday, 6 = Saturday)
                let startingDay = firstDay.getDay();

                // Get days from previous month
                const prevMonthLastDay = new Date(year, month, 0).getDate();
                for (let i = 0; i < startingDay; i++) {
                    const day = document.createElement('div');
                    day.className = 'p-2 text-gray-400';
                    day.textContent = prevMonthLastDay - startingDay + i + 1;
                    calendarGrid.appendChild(day);
                }

                // Current month days
                const today = new Date();
                const currentDay = today.getDate();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();

                for (let i = 1; i <= daysInMonth; i++) {
                    const day = document.createElement('div');

                    // Disable past dates
                    const dateToCheck = new Date(year, month, i);
                    const isPastDate = dateToCheck < today && !(i === currentDay && month === currentMonth && year === currentYear);

                    if (isPastDate) {
                        day.className = 'p-2 text-gray-400';
                    } else {
                        day.className = 'p-2 date-hover rounded';
                        day.addEventListener('click', function () {
                            // Remove selected class from all dates
                            document.querySelectorAll('.date-hover').forEach(d => {
                                d.classList.remove('date-selected');
                            });

                            // Add selected class to clicked date
                            this.classList.add('date-selected');

                            // Get selected date
                            selectedDate = new Date(year, month, i);
                            fetchAvailableTimeSlots(selectedDate);
                        });
                    }

                    day.textContent = i;
                    calendarGrid.appendChild(day);
                }

                // Next month days
                const totalCells = 42; // 6 rows of 7 days
                const cellsToFill = totalCells - (startingDay + daysInMonth);
                for (let i = 1; i <= cellsToFill; i++) {
                    const day = document.createElement('div');
                    day.className = 'p-2 text-gray-400';
                    day.textContent = i;
                    calendarGrid.appendChild(day);
                }
            }

            function fetchAvailableTimeSlots(date) {
                if (!date || !timezoneSelect.value) return;

                const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                const selectedTimezone = timezoneSelect.value;

                timeSlotsGrid.innerHTML = '<div class="text-center text-gray-500 col-span-2 py-4">Loading available slots...</div>';

                fetch('{% url "get_available_slots" %}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date: formattedDate, timezone: selectedTimezone })
                })
                    .then(response => response.json())
                    .then(data => {
                        timeSlotsGrid.innerHTML = '';

                        if (data.available_slots && data.available_slots.length > 0) {
                            data.available_slots.forEach(slot => {
                                const [hour, minute] = slot.split(':').map(Number);
                                const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                                const ampm = hour >= 12 ? 'PM' : 'AM';
                                const displayTime = `${displayHour}:${minute.toString().padStart(2, '0')} ${ampm}`;

                                const timeButton = document.createElement('button');
                                timeButton.className = 'time-slot bg-blue-200 hover:bg-blue-300 text-blue-800 py-3 px-4 rounded-md text-sm font-medium';
                                timeButton.textContent = displayTime;
                                timeButton.setAttribute('data-time', slot);

                                timeButton.addEventListener('click', function () {
                                    document.querySelectorAll('.time-slot').forEach(t => t.classList.remove('time-selected'));
                                    this.classList.add('time-selected');
                                    selectedTimeString = this.getAttribute('data-time');
                                });

                                timeSlotsGrid.appendChild(timeButton);
                            });
                        } else {
                            timeSlotsGrid.innerHTML = '<div class="text-center text-gray-500 col-span-2 py-4">No available slots for this date</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching available slots:', error);
                        timeSlotsGrid.innerHTML = '<div class="text-center text-red-500 col-span-2 py-4">Error loading available slots. Please try again.</div>';
                    });
            }

            // Show details form when "Fill Details" button is clicked
            showDetailsBtn.addEventListener('click', function () {
                if (!selectedDate) {
                    alert('Please select a date');
                    return;
                }

                if (!selectedTimeString) {
                    alert('Please select a time slot');
                    return;
                }

                // Set hidden form fields
                document.getElementById('booking_date').value = `${selectedDate.getFullYear()}-${(selectedDate.getMonth() + 1).toString().padStart(2, '0')}-${selectedDate.getDate().toString().padStart(2, '0')}`;
                document.getElementById('booking_time').value = selectedTimeString;
                document.getElementById('booking_timezone').value = timezoneSelect.value;

                // Show form
                document.getElementById('timeSlotContainer').classList.add('hidden');
                document.getElementById('detailsFormContainer').classList.remove('hidden');
            });

            // Handle form submission
            bookingForm.addEventListener('submit', function (e) {
                e.preventDefault();

                // Collect form data
                const formData = new FormData(this);

                // Submit form via AJAX
                fetch('{% url "book_slot" %}', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Redirect to confirmation page
                            window.location.href = `/confirmation/${data.booking_id}/`;
                        } else {
                            // Show errors
                            let errorMessage = 'Please correct the following errors:\n';
                            for (const field in data.errors) {
                                errorMessage += `- ${field}: ${data.errors[field]}\n`;
                            }
                            alert(errorMessage);
                        }
                    })
                    .catch(error => {
                        console.error('Error booking slot:', error);
                        alert('An error occurred while booking your slot. Please try again.');
                    });
            });
        });


        //Load Timezones dynamically
        document.addEventListener("DOMContentLoaded", function () {
            const timezoneSelect = document.getElementById("timezone");

            fetch("/get_timezones/")
                .then(response => response.json())
                .then(data => {
                    timezoneSelect.innerHTML = '<option value="" disabled selected>Select your timezone</option>';

                    data.timezones.forEach(tz => {
                        const option = document.createElement("option");
                        option.value = tz.value;
                        option.textContent = tz.label;
                        timezoneSelect.appendChild(option);
                    });
                })
                .catch(error => console.error("Error fetching timezones:", error));
        });

    </script>
</body>

</html>